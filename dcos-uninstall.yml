- hosts: all
  remote_user: root
  become: yes
  become_method: sudo
  vars_files:
    - vars/dcos-settings.yml
  tasks:

    - name: Uninstall nodes
      command: /opt/mesosphere/bin/pkgpanda uninstall

    - name: Delete /var/lib/dcos
      file: path=/var/lib/dcos state=absent

    - name: Delete /var/lib/mesos
      file: path=/var/lib/mesos state=absent

    - name: Delete /opt/mesosphere
      file: path=/opt/mesosphere state=absent

    - name: Delete /etc/mesosphere
      file: path=/etc/mesosphere state=absent

    # Delete resolv.conf. After reboot original resolv.conf sholde be generated by system
    - name: Delete /etc/resolv.conf
      file: path=/etc/resolv.conf state=absent

    - name: Delete /etc/systemd/journald.conf.d
      file: path=/etc/systemd/journald.conf.d state=absent

    - name: Delete /etc/systemd/system/dcos*
      shell: rm -rf /etc/systemd/system/dcos*

    - name: Delete /opt/dcos*
      shell: rm -rf /opt/dcos*

    - name: Daemon-reload
      shell: systemctl daemon-reload

    - name: restart machine
      shell: sleep 2 && shutdown -r now "Ansible updates triggered"
      async: 1
      poll: 0
      ignore_errors: true

    - name: waiting for server to come back
      local_action: wait_for host={{ inventory_hostname }} state=started delay=30 timeout=300
      sudo: false
